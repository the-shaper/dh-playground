(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/const x=document.getElementById("canvas"),c=document.getElementById("canvas-container"),T=document.getElementById("customText"),Z=document.getElementById("start-prompt"),ee=document.getElementById("start-btn"),te=document.getElementById("changePatternBtn"),ne=document.getElementById("clearBtn"),oe=document.getElementById("saveBtn"),N=document.getElementById("restartSequenceBtn"),M=document.getElementById("word-mode-toggle"),re=document.getElementById("select-mode-toggle"),D=document.getElementById("overwrite-toggle"),R=document.getElementById("tempo-toggle"),ae=document.getElementById("tempo-controls"),se=document.getElementById("follow-mouse-toggle"),z=document.getElementById("bpm-slider"),ie=document.getElementById("bpm-value"),G=document.getElementById("rate-selector"),f=document.getElementById("selection-box"),ce=document.getElementById("ratio-toolbar"),le=document.getElementById("canvas-wrapper"),de=document.getElementById("patternInfo"),O=document.getElementById("bgColorPicker"),W=document.getElementById("textColorPicker");let K=!1,l=[],y=0,E=0,g=0,h=0,v=0,p=0,w=0,B=0,b,F=[],L="draw",s={active:!1,startCol:-1,startRow:-1,endCol:-1,endRow:-1,isDragging:!1,content:[]},U="auto",$,d={headCol:0,headRow:0,active:!1},ge={clientX:0,clientY:0};const I=[{name:"C Major Arp (Up)",characters:["<","-","=",">"],notes:["C4","E4","G4","C5"]},{name:"A Minor Arp (Up/Down)",characters:["/","^","\\","v"],notes:["A3","C4","E4","A4","E4","C4"]},{name:"G Major Arp (Wide)",characters:[".","o","O","0","@","*"],notes:["G3","B3","D4","G4","B4","D5"]},{name:"F Major 7 Arp (Jazzy)",characters:["~","`",",",";"],notes:["F3","A3","C4","E4"]},{name:"E Minor Pentatonic (Bluesy)",characters:["-","_","=","#","+"],notes:["E3","G3","A3","B3","D4"]},{name:"Floyd's Money (B Minor)",characters:["M","O","N","E","Y"],notes:["B2","F#3","B2","A2","B2","F#2","A2","D3"]}];async function ye(){await Tone.start(),b=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"fmsine"},envelope:{attack:.01,decay:.2,sustain:.1,release:.5}}).toDestination(),Z&&(Z.style.display="none")}function Ce(){const e=document.createElement("span");if(!x)return;const t=getComputedStyle(x);e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,e.style.lineHeight=t.lineHeight,e.style.visibility="hidden",e.style.position="absolute",e.textContent="M",document.body.appendChild(e),g=e.getBoundingClientRect().width,h=e.getBoundingClientRect().height,document.body.removeChild(e),(g<=0||h<=0)&&(console.warn("Calculated charWidth or charHeight is zero or negative. Fallback to default."),g=8,h=16),c&&(y=Math.floor(c.clientWidth/g),E=Math.floor(c.clientHeight/h),(y<=0||E<=0)&&console.warn(`Invalid grid dimensions: ${y}x${E}. Client: ${c.clientWidth}x${c.clientHeight}, Char: ${g}x${h}`))}function Y(){Ie(),Ce(),!(isNaN(E)||isNaN(y)||E<=0||y<=0)&&(l=Array.from({length:E},()=>Array(y).fill(" ")),F=[],k(),S())}function S(){x&&l.length>0&&(x.textContent=l.map(e=>e.join("")).join(`
`))}function V(){de&&(de.textContent=`Sound: ${I[v].name}`)}function J(e,t){if(!C(e,t)||!T||!M)return 0;const n=T.value.replace(/(\r\n|\n|\r)/gm," "),r=I[v];return M.checked&&n.length>0?me(e,t,n,r):he(e,t,n,r)}function he(e,t,n,r){let o,a;if(n.length>0)p>=n.length&&(p=0),o=n[p],a=r.notes[p%r.notes.length],p++;else{const m=B%r.notes.length,u=B%r.characters.length;a=r.notes[m],o=r.characters[u],B++}return o===" "||(D&&D.checked||l[t]&&l[t][e]===" ")&&(l[t][e]=o,F.push({type:"char",row:t,col:e,wasCustom:n.length>0}),S(),b&&b.triggerAttackRelease(a,"8n",Tone.now())),1}function me(e,t,n,r){const o=n.split(" ").filter(u=>u.length>0);if(o.length===0)return 0;w>=o.length&&(w=0);const a=o[w];if(e+a.length>y)return 0;let i=[];for(let u=0;u<a.length;u++){const P=e+u;if(!(D&&D.checked||l[t]&&l[t][P]===" "))return 0;i.push({char:a[u],row:t,col:P})}i.forEach(u=>{l[u.row]&&(l[u.row][u.col]=u.char)}),F.push({type:"word",chars:i}),S();const m=r.notes.slice(0,Math.min(3,r.notes.length));return b&&m.length>0&&b.triggerAttackRelease(m,"4n",Tone.now()),w++,a.length}function fe(e){K=!0;const{col:t,row:n}=H(e);C(t,n)&&(R&&R.checked?(d.headCol=t,d.headRow=n,d.active=!0,Tone.Transport.state!=="started"&&Tone.Transport.start()):L==="draw"?J(t,n):L==="select"&&(s.active&&Re(t,n)?(s.isDragging=!0,f&&f.classList.add("is-dragging"),s.dragStartCol=t,s.dragStartRow=n,Ee(),we(),S()):(k(),s.active=!0,s.startCol=t,s.startRow=n,s.endCol=t,s.endRow=n,_())))}function ue(e){if(ge={clientX:e.clientX??e.touches[0].clientX,clientY:e.clientY??e.touches[0].clientY},M&&M.checked||!K||R&&R.checked)return;const{col:t,row:n}=H(e);if(L==="draw"){if(!C(t,n))return;J(t,n)}else if(L==="select"&&s.active)if(s.isDragging){const{startC:r,startR:o}=A(),a=t-(s.dragStartCol??0),i=n-(s.dragStartRow??0),m=r*g+a*g,u=o*h+i*h;f&&(f.style.transform=`translate(${m-r*g}px, ${u-o*h}px)`)}else{if(!C(t,n))return;s.endCol=t,s.endRow=n,_()}}function pe(e){K=!1,R&&R.checked&&L==="select"&&s.isDragging||(d.active=!1),L==="select"&&(s.isDragging&&Be(H(e)),s.isDragging=!1,f&&(f.classList.remove("is-dragging"),f.style.transform="translate(0, 0)"),s.active&&_())}function Ee(){s.content=[];const{startC:e,startR:t,endC:n,endR:r}=A();for(let o=t;o<=r;o++){let a=[];for(let i=e;i<=n;i++)l[o]&&l[o][i]!==void 0?a.push(l[o][i]):a.push(" ");s.content.push(a)}}function we(){const{startC:e,startR:t,endC:n,endR:r}=A();for(let o=t;o<=r;o++)for(let a=e;a<=n;a++)C(a,o)&&l[o]&&(l[o][a]=" ")}function Be({col:e,row:t}){const n=e-(s.dragStartCol??0),r=t-(s.dragStartRow??0),{startC:o,startR:a}=A(),i=o+n,m=a+r;s.content.forEach((u,P)=>{u.forEach((X,ve)=>{const q=m+P,Q=i+ve;C(Q,q)&&X!==" "&&l[q]&&(l[q][Q]=X)})}),S(),k()}function k(){s={active:!1,startCol:-1,startRow:-1,endCol:-1,endRow:-1,isDragging:!1,content:[]},f&&(f.classList.add("hidden"),f.style.transform="translate(0,0)")}function A(){const e=Math.min(s.startCol,s.endCol),t=Math.min(s.startRow,s.endRow),n=Math.max(s.startCol,s.endCol),r=Math.max(s.startRow,s.endRow);return{startC:e,startR:t,endC:n,endR:r}}function _(){if(!s.active||!f){f&&f.classList.add("hidden");return}f.classList.remove("hidden");const{startC:e,startR:t,endC:n,endR:r}=A();isNaN(e*g)||g===0||h===0||(f.style.left=`${e*g}px`,f.style.top=`${t*h}px`,f.style.width=`${(n-e+1)*g}px`,f.style.height=`${(r-t+1)*h}px`)}function H(e){if(!c||!g||!h||g===0||h===0)return{col:-1,row:-1};const t=c.getBoundingClientRect();let n,r;if("touches"in e&&e.touches&&e.touches.length>0)n=e.touches[0].clientX,r=e.touches[0].clientY;else if("clientX"in e&&"clientY"in e)n=e.clientX,r=e.clientY;else return console.warn("getCoordsFromEvent: Could not extract coordinates from event",e),{col:-1,row:-1};return{col:Math.floor((n-t.left)/g),row:Math.floor((r-t.top)/h)}}function C(e,t){return t>=0&&t<E&&e>=0&&e<y}function Re(e,t){if(!s.active)return!1;const{startC:n,startR:r,endC:o,endR:a}=A();return e>=n&&e<=o&&t>=r&&t<=a}function Le(e){if(document.activeElement===T)return;let t=!1;switch(e.key.toLowerCase()){case"backspace":if(e.preventDefault(),s.active)we(),S(),k();else if(F.length>0&&b){const n=F.pop();n&&(n.type==="word"&&n.chars?(n.chars.forEach(r=>{C(r.col,r.row)&&l[r.row]&&(l[r.row][r.col]=" ")}),w>0&&w--):n.type==="char"&&n.row!==void 0&&n.col!==void 0&&(C(n.col,n.row)&&l[n.row]&&(l[n.row][n.col]=" "),n.wasCustom?p>0&&p--:B>0&&B--),S(),b.triggerAttackRelease("C2","8n",Tone.now()))}break;case"a":v=(v-1+I.length)%I.length,t=!0;break;case"s":v=(v+1)%I.length,t=!0;break;case"escape":k();break}t&&(B=0,p=0,w=0,V())}function Ie(){if(!le||!c)return;const e=le.getBoundingClientRect();let t=e.width,n=e.height;if(U!=="auto"){const[r,o]=U.split("/").map(Number),a=r/o;n=t/a,n>e.height&&(n=e.height,t=n*a)}c.style.width=`${t}px`,c.style.height=`${n}px`}ee&&ee.addEventListener("click",ye);window.addEventListener("resize",Y);ne&&ne.addEventListener("click",Y);document.addEventListener("keydown",Le);te&&te.addEventListener("click",()=>{v=(v+1)%I.length,B=0,p=0,w=0,V()});N&&N.addEventListener("click",()=>{p=0,w=0,B=0,N.classList.add("bg-green-500"),setTimeout(()=>{N.classList.remove("bg-green-500")},300)});T&&T.addEventListener("input",()=>{p=0,w=0});c&&(c.addEventListener("mousedown",fe),c.addEventListener("mousemove",ue),c.addEventListener("touchstart",e=>{e.preventDefault(),fe(e)},{passive:!1}),c.addEventListener("touchmove",e=>{e.preventDefault(),ue(e)},{passive:!1}));document.addEventListener("mouseup",pe);document.addEventListener("touchend",pe);re&&re.addEventListener("change",e=>{L=e.target.checked?"select":"draw",c&&(c.style.cursor=L==="select"?"crosshair":"text"),k()});R&&z&&G&&T&&M&&se&&D&&R.addEventListener("change",e=>{const t=e.target.checked;ae&&ae.classList.toggle("hidden",!t),D.disabled=t,t?(Tone.Transport.bpm.value=parseInt(z.value),$=new Tone.Loop(n=>{Tone.Draw.schedule(()=>{if(d.active){let r=0;if(se.checked){const{col:o,row:a}=H(ge);C(o,a)&&J(o,a)}else{const o=T.value.replace(/(\r\n|\n|\r)/gm," "),a=I[v];if(M.checked&&o.length>0){const i=o.split(" ").filter(m=>m.length>0);if(i.length>0){const m=i[w%i.length];r=me(d.headCol,d.headRow,o,a),d.headCol+=r>0?m.length+1:1}else d.headCol++}else r=he(d.headCol,d.headRow,o,a),d.headCol+=r;d.headCol>=y&&(d.headCol=0,d.headRow++),d.headRow>=E&&(d.headRow=0)}}},n)},G.value).start(0),Tone.Transport.state!=="started"&&Tone.Transport.start()):($&&$.dispose(),Tone.Transport.stop(),d.active=!1)});z&&ie&&z.addEventListener("input",e=>{const t=parseInt(e.target.value);ie.textContent=t.toString(),Tone.Transport.bpm.value=t});G&&G.addEventListener("change",e=>{$&&($.interval=e.target.value)});O&&c&&O.addEventListener("input",e=>{c.style.backgroundColor=e.target.value});W&&x&&W.addEventListener("input",e=>{x.style.color=e.target.value});oe&&c&&O&&W&&oe.addEventListener("click",()=>{k(),setTimeout(()=>{html2canvas(c,{backgroundColor:O.value,onclone:e=>{const t=e.getElementById("canvas");t&&(t.style.color=W.value)}}).then(e=>{const t=document.createElement("a");t.download="ascii-sound-drawer.png",t.href=e.toDataURL("image/png"),t.click()})},100)});ce&&ce.addEventListener("click",e=>{const t=e.target;t.classList.contains("ratio-btn")&&(U=t.dataset.ratio||"auto",document.querySelectorAll(".ratio-btn").forEach(n=>n.classList.remove("active")),t.classList.add("active"),Y())});function j(){Y(),V()}document.fonts?document.fonts.ready.then(j).catch(e=>{console.warn("Font loading error or timeout, initializing app with fallback.",e),j()}):window.addEventListener("load",j);
